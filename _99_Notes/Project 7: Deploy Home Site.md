### **Project 7: Deploy Home App**

**Mission:** Build the React application for production and deploy it to the DigitalOcean droplet to be served by Nginx.

* * *

**7.1. Final Architecture: Dockerized Frontend** The deployment strategy was evolved into a more robust and professional architecture. Instead of the main Nginx proxy serving the frontend files directly, the React application was fully containerized to run as its own service.

- A multi-stage `Dockerfile` was created at `apps/shell/Dockerfile`. This file defines the process for building the React app in a Node.js environment and then serving the static `dist` files from a lightweight Nginx container.
    
- A new `frontend` service was added to `backend-config/docker-compose.yml`, which is responsible for building and running this new frontend container.
    
- The original `nginx` service was repurposed as an `nginx-proxy` to direct traffic: requests for `api.wade-usa.com` go to the `directus` container, and requests for `wade-usa.com` go to the new `frontend` container.
    

**7.2. Deployment Workflow** The final, correct deployment workflow is entirely managed through Git and Docker Compose:

1.  **Local Development:** Make all code changes locally.
    
2.  **Build Frontend:** Run `pnpm --filter @wade-usa/shell build` to create the production `dist` folder.
    
3.  **Commit & Push:** Commit all changes (including the `dist` folder, `Dockerfile`, etc.) to the GitHub repository.
    
4.  **Pull on Server:** SSH into the droplet and run `git pull origin main` to get the latest code.
    
5.  **Deploy with Docker Compose:** From the `backend-config` directory on the server, run `docker compose up -d --build`. The `--build` flag tells Docker to build the new frontend image from its `Dockerfile` before starting all the services.
    

**7.3. Troubleshooting the Deployment** The deployment process involved several critical troubleshooting steps:

- **Initial Build Failure:** The production build initially failed because workspace packages did not correctly list `react-router-dom` as a `peerDependency`. This was fixed by updating the `package.json` for the `@wade-usa/auth` package: Rollup failed to resolve import "react-router-dom" from "/home/mark/Documents/wade-usa-v3/packages/auth/src/ProtectedRoute.jsx".\\nThis is most likely unintended because it can break your application at runtime.\\nIf you do want to externalize this module explicitly add it to\\n`build.rollupOptions.external`\\n at viteWarn ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65839:17)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65839:17)%5C%5Cn") at onwarn ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/@vitejs+plugin-react@4.6.0_vite@5.4.19/node_modules/@vitejs/plugin-react/dist/index.mjs:104:9)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/@vitejs+plugin-react@4.6.0_vite@5.4.19/node_modules/@vitejs/plugin-react/dist/index.mjs:104:9)%5C%5Cn") at onRollupWarning ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65869:5)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65869:5)%5C%5Cn") at onwarn ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65534:7)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/vite@5.4.19/node_modules/vite/dist/node/chunks/dep-C6uTJdX2.js:65534:7)%5C%5Cn") at [file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:20817:13\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:20817:13%5C%5Cn") at Object.logger \[as onLog\] ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:22683:9)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:22683:9)%5C%5Cn") at ModuleLoader.handleInvalidResolvedId ([file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:21429:26)\\\\n](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:21429:26)%5C%5Cn") at [file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:21387:26\\\\n/home/mark/Documents/wade-usa-v3/apps/shell:\\\\n\\\\u001b\\\[91m](# "file:///home/mark/Documents/wade-usa-v3/node_modules/.pnpm/rollup@4.44.1/node_modules/rollup/dist/es/shared/node-entry.js:21387:26%5C%5Cn/home/mark/Documents/wade-usa-v3/apps/shell:%5C%5Cn%5C%5Cu001b%5C%5B91m")â€‰ERR_PNPM_RECURSIVE_RUN_FIRST_FAIL\\u001b\[0m @wade-usa/shell@0.0.0 build: `vite build`\\nExit status 1\\nmark@r2-d2:~/Documents/wade-usa-v3$\].
    
- **Dockerfile Build Error:** The Docker build failed with a "not found" error because the `COPY` instruction had an incorrect path for `nginx.conf`. This was resolved by providing the full path relative to the build context (`apps/shell/nginx.conf`) in the `Dockerfile` Building 0.4s (17/18) docker:default\\n => \[frontend internal\] load build definition from Dockerfile 0.0s\\n => => transferring dockerfile: 1.84kB 0.0s\\n => \[frontend internal\] load metadata for docker.io/library/node:18-alpine 0.3s\\n => \[frontend internal\] load metadata for docker.io/library/nginx:stable-alpine 0.3s\\n => \[frontend internal\] load .dockerignore 0.0s\\n => => transferring context: 2B 0.0s\\n => \[frontend builder 1/9\] FROM docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc49833 0.0s\\n => => resolve docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d11894558 0.0s\\n => \[frontend internal\] load build context 0.0s\\n => => transferring context: 7.98kB 0.0s\\n => \[frontend stage-1 1/4\] FROM docker.io/library/nginx:stable-alpine@sha256:aed99734248e851764f1f 0.0s\\n => => resolve docker.io/library/nginx:stable-alpine@sha256:aed99734248e851764f1f2146835ecad42b5f9 0.0s\\n => CACHED \[frontend builder 2/9\] WORKDIR /app 0.0s\\n => CACHED \[frontend builder 3/9\] COPY ../../package.json ../../pnpm-lock.yaml ./ 0.0s\\n => CACHED \[frontend builder 4/9\] COPY ../../pnpm-workspace.yaml ./ 0.0s\\n => CACHED \[frontend builder 5/9\] COPY ../../packages /app/packages 0.0s\\n => CACHED \[frontend builder 6/9\] COPY ../../apps/shell /app/apps/shell 0.0s\\n => CACHED \[frontend builder 7/9\] RUN npm install -g pnpm 0.0s\\n => CACHED \[frontend builder 8/9\] RUN pnpm install 0.0s\\n => CACHED \[frontend builder 9/9\] RUN pnpm --filter @wade-usa/shell build 0.0s\\n => CACHED \[frontend stage-1 2/4\] COPY --from=builder /app/apps/shell/dist /usr/share/nginx/html 0.0s\\n => ERROR \[frontend stage-1 3/4\] COPY nginx.conf /etc/nginx/conf.d/default.conf 0.0s\\n------\\n > \[frontend stage-1 3/4\] COPY nginx.conf /etc/nginx/conf.d/default.conf:\\n------\\nfailed to solve: failed to compute cache key: failed to calculate checksum of ref 0ad2723c-a45a-46fc-9a2c-d8d343d4422d::rn59ywlwifx69f7lwel502a5b: "/nginx.conf": not found\\nwade@Wade-Server:~/[wade-usa.com/backend-config$](https://www.google.com/search?q=https://wade-usa.com/backend-config%24) /// also notive the docker compose instead of docker-compose which would throw error\].
    
- **Port Conflict Error:** The `nginx-proxy` container failed to start due to `Bind for 0.0.0.0:80 failed: port is already allocated`. This was caused by an "orphaned" `docker-proxy` process from a previous failed attempt. The conflict was resolved by stopping all services with `docker compose down --remove-orphans` and restarting the stack password for wade: \\nCOMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME\\ndocker-pr 29672 root 7u IPv4 109942 0t0 TCP \*:http (LISTEN)\\ndocker-pr 29678 root 7u IPv6 109943 0t0 TCP \*:http (LISTEN)\\nwade@Wade-Server:~/[wade-usa.com/backend-config$](https://www.google.com/search?q=https://wade-usa.com/backend-config%24)\].
    
- **Mixed Content Warning:** The deployed site was "not secure" because the API URL in the code was `http://` instead of `https://`. This was fixed by updating the URL in `packages/auth/src/api.js` and re-deploying.